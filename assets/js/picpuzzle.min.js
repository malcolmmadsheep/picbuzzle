"use strict";function Picpuzzle(){}function ImageCell(a,b,c,d,e,f,g,h){this.id=a,this.coords={},this.coords.x=d,this.coords.y=e,this.sx=b,this.sy=c,this.width=f,this.height=g,this.image=h}!function(){Picpuzzle.prototype.CANVAS_WIDTH=512,Picpuzzle.prototype.CANVAS_HEIGHT=512,Picpuzzle.prototype.CELL_WIDTH=0,Picpuzzle.prototype.CELL_HEIGHT=0,Picpuzzle.prototype.TWEEN_DURATION=25,Picpuzzle.prototype.DIRECTIONS=["up","right","down","left"],Picpuzzle.prototype.SECTIONS=null,Picpuzzle.prototype.SECTIONS_NAMES=["menu","game","results"],Picpuzzle.prototype.swapCount=0,Picpuzzle.prototype.imgSource="",Picpuzzle.prototype.context=null,Picpuzzle.prototype.field=[],Picpuzzle.prototype.rows=-1,Picpuzzle.prototype.cols=-1,Picpuzzle.prototype.isMoving=!1,Picpuzzle.prototype.isShuffling=!1,Picpuzzle.prototype.directionsQueue=[],Picpuzzle.prototype.startTouchCoords={},Picpuzzle.prototype.isInitiated=!1,Picpuzzle.prototype.fontSize=40,Picpuzzle.prototype.level=3,Picpuzzle.prototype.isSolved=!1,Picpuzzle.prototype.needText=!0,Picpuzzle.prototype.startGame=function(a,b){this.setActiveSection("game"),this.init(a,b)},Picpuzzle.prototype.setupCanvas=function(){if(null===this.context){var a=document.createElement("canvas");a.width=this.CANVAS_WIDTH,a.height=this.CANVAS_HEIGHT,a.addEventListener("touchstart",this.canvasTouchStart.bind(this),!1),a.addEventListener("touchend",this.canvasTouchEnd.bind(this),!1),this.context=a.getContext("2d"),$(a).insertBefore("#game-buttons")}},Picpuzzle.prototype.init=function(a,b){window.innerWidth<this.CANVAS_WIDTH&&(this.CANVAS_WIDTH=this.CANVAS_HEIGHT=Math.ceil(window.innerWidth-50)),this.level=a,this.needText=!0,this.rows=this.cols=parseInt(a),this.CELL_WIDTH=this.CELL_HEIGHT=Math.floor(this.CANVAS_WIDTH/a),this.fontSize=Math.ceil(this.CELL_WIDTH/3),this.field.length=this.rows*this.cols,this.swapCount=0,this.setImageSource(b),this.setupCanvas(),this.setupField();for(var c=0;c++<40;)this.draw();this.isInitiated=!0},Picpuzzle.prototype.setupField=function(){this.imgSource=this.resize(this.imgSource);for(var a=0;a<this.rows;a++)for(var b=0;b<this.cols;b++){var c=this.getId(a,b),d=b*this.CELL_WIDTH,e=a*this.CELL_HEIGHT,f=new Image;f.src=this.imgSource,c===this.field.length-1&&(f=null),this.field[c]=new ImageCell(c,d,e,d,e,this.CELL_WIDTH,this.CELL_HEIGHT,f)}this.shuffle()},Picpuzzle.prototype.draw=function(){var a=-1,b=null,c=this;this.context.canvas.width=this.context.canvas.width;for(var d=0;d<this.rows;d++)for(var e=0;e<this.cols;e++)a=this.getId(d,e),b=this.field[a],null!==b.image&&c.context.drawImage(b.image,b.sx,b.sy,b.width,b.height,b.coords.x,b.coords.y,b.width,b.height);this.needText&&this.drawSwapCountText(this.CANVAS_WIDTH-this.fontSize-10,this.fontSize+5)},Picpuzzle.prototype.shuffle=function(){var a=this.field.length;this.field;this.isShuffling=!0;for(var c=0;a>c;c++){var d=Math.floor(Math.random()*c);this.swapCells(c,d)}this.isShuffling=!1,this.resetSwaps(),this.draw()},Picpuzzle.prototype.resize=function(a){var b=document.createElement("canvas"),c=b.getContext("2d"),d=new Image;return d.src=a,b.width=this.CANVAS_WIDTH,b.height=this.CANVAS_HEIGHT,c.drawImage(d,0,0,d.width,d.height,0,0,b.width,b.height),b.toDataURL()},Picpuzzle.prototype.setImageSource=function(a){this.imgSource=a},Picpuzzle.prototype.run=function(){var a=this.getEmptyCell(),b=this.field.length,c=-1;if(!this.isMoving&&0!==this.directionsQueue.length){var d=this.getNextDirection();d!==this.DIRECTIONS[0]||a>=b-this.cols&&b>a?d===this.DIRECTIONS[1]&&a%this.rows!==0?(c=a-1,this.tweenCell(a,c)):d!==this.DIRECTIONS[2]||a>=0&&a<this.cols?d===this.DIRECTIONS[3]&&a%this.rows!==this.cols-1?(c=a+1,this.tweenCell(a,c)):(this.dequeueDirection(),this.run()):(c=a-this.cols,this.tweenCell(a,c)):(c=a+this.cols,this.tweenCell(a,c))}},Picpuzzle.prototype.move=function(a){this.enqueueDirection(a),this.run()},Picpuzzle.prototype.check=function(){for(var a=this.field,b=a.length,d=0;b>d;d++)if(d!==a[d].id)return!1;return!0},Picpuzzle.prototype.swapCells=function(a,b){var c=this.field[a];this.field[a].coords=this.getCoordsById(b),this.field[b].coords=this.getCoordsById(a),this.field[a]=this.field[b],this.field[b]=c,this.swapEnding()},Picpuzzle.prototype.swapEnding=function(){this.isShuffling||this.swapCount++,this.directionsQueue.pop(),this.isMoving=!1,this.draw(),this.run(),!this.isShuffling&&this.check()&&(this.isSolved=!0,this.displayResults())},Picpuzzle.prototype.getEmptyCell=function(){for(var a=this.field,b=a.length,c=0;b>c;c++)if(a[c].id===b-1)return c},Picpuzzle.prototype.tweenCell=function(a,b){var c=this.field,d=c[a].coords,e=c[b].coords,f=d.x-e.x,g=d.y-e.y,h=Math.round(this.CELL_WIDTH/this.TWEEN_DURATION*100)/100,j=this,k={deltaM:h,to:a,from:b,coord:"x",dV:Math.abs(f),puzzle:j};this.isMoving||(0>f?k.deltaM=-h:0===f&&(k.coord="y",k.dV=Math.abs(g)),0>g&&(k.deltaM=-h),this.animate(k))},Picpuzzle.prototype.animate=function(a){var b=a.puzzle.field,c=Math.abs(a.deltaM),d=setInterval(function(){a.dV-=c,b[a.from].coords[a.coord]=b[a.from].coords[a.coord]+a.deltaM,a.puzzle.draw(),a.dV<=0&&(clearInterval(d),a.puzzle.swapCells(a.to,a.from))},1);this.isMoving=!0},Picpuzzle.prototype.getId=function(a,b){return a*this.rows+b},Picpuzzle.prototype.getCoordsById=function(a){var b={};return b.x=a%this.cols*this.CELL_WIDTH,b.y=Math.floor((a-a%this.cols)/this.rows)*this.CELL_HEIGHT,b},Picpuzzle.prototype.enqueueDirection=function(a){this.directionsQueue.unshift(a)},Picpuzzle.prototype.dequeueDirection=function(){return this.directionsQueue.pop()},Picpuzzle.prototype.getNextDirection=function(){var a=this.directionsQueue.length;return this.directionsQueue[a-1]},Picpuzzle.prototype.handleKeyInput=function(a){var b=a.keyCode,c="";switch(b){case 38:c=this.DIRECTIONS[0];break;case 39:c=this.DIRECTIONS[1];break;case 40:c=this.DIRECTIONS[2];break;case 37:c=this.DIRECTIONS[3]}""!==c&&this.isInitiated&&this.move(c)},Picpuzzle.prototype.canvasTouchStart=function(a){a.preventDefault();var b=a.changedTouches[0];this.startTouchCoords.x=b.screenX,this.startTouchCoords.y=b.screenY},Picpuzzle.prototype.canvasTouchEnd=function(a){var b=a.changedTouches[0],c={x:b.screenX,y:b.screenY},d=this.startTouchCoords.x-c.x,e=this.startTouchCoords.y-c.y,f="";Math.abs(d)>Math.abs(e)?d>0?f=this.DIRECTIONS[3]:0>d&&(f=this.DIRECTIONS[1]):e>0?f=this.DIRECTIONS[0]:0>e&&(f=this.DIRECTIONS[2]),""!==f&&this.isInitiated&&this.move(f)},Picpuzzle.prototype.setActiveSection=function(a){for(var b=this.SECTIONS,c=0;c<b.length;c++)b[c].isActive&&($(b[c]).css({display:"none"}),document.body.removeChild(b[c]),b[c].isActive=!1);var d=this.SECTIONS[this.SECTIONS_NAMES.indexOf(a)];d.isActive=!0,document.body.appendChild(d),$(d).fadeIn(1e3)},Picpuzzle.prototype.displayResults=function(){var a=this.SECTIONS_NAMES.indexOf("results"),b="YOU'VE BEEN SOLVED THIS BUZZLE!",c="CONGRATULATIONS!";this.setActiveSection(this.SECTIONS_NAMES[a]),this.isSolved||(this.needText=!1,this.draw(),this.imgSource=this.context.canvas.toDataURL(),b="Oh, I think you've tried not enough! Push \"AGAIN\" button and show me that you're the BEST!",c="What a pitty!"),$("#resultImage").prop("src",this.imgSource),$("#result-title").text(c),$("#swapNumber").text(this.swapCount),$("#conclusion").text(b)},Picpuzzle.prototype.drawSwapCountText=function(a,b){this.context.moveTo(0,0),this.context.font="bold "+this.fontSize+"px Arial",this.context.fillStyle="#fff",this.context.lineWidth="5px",this.context.strokeStyle="#000",this.context.textAlign="center",this.context.fillText(this.swapCount,a,b),this.context.strokeText(this.swapCount,a,b)},Picpuzzle.prototype.goToResultsButtonClick=function(a){this.displayResults()},Picpuzzle.prototype.tryAgainButtonClick=function(a){this.setActiveSection("menu")},Picpuzzle.prototype.resetSwaps=function(){this.swapCount=0}}();